<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Kendaraan Jala</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main content -->
    <main id="mainContent" class="main-content bg-light p-4">
      <div class="container mt-5">
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="table-card">
              <div class="table-title">Data Kendaraan Jala (API GPS.id)</div>
              <div class="table-responsive">
                <table class="table dashboard-table align-middle">
                  <thead class="table-header">
                    <tr>
                      <th>No</th>
                      <th>Plat Nomor</th>
                      <th class="text-start">Nama Kendaraan</th>
                      <th>IMEI</th>
                      <th>Jenis BBM</th>
                      <th>Mileage</th>
                      <th>Update Terakhir</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for k in kendaraan %}
                    <tr>
                      <td>{{ loop.index }}</td>
                      <td>{{ k.plate }}</td>
                      <td>
                        <input type="text" class="form-control form-control-sm"
                               value="{{ k.custom_name if k.custom_name else k.device_name }}"
                               onchange="updateName('{{ k.imei }}', this.value)">
                      </td>
                      <td>{{ k.imei }}</td>
<td>
  <select class="form-select form-select-sm fuel-select"
          onchange="updateFuelType('{{ k.imei }}', this)">
    <option value="None" {% if k.fuel_type == 'None' %}selected{% endif %}>None</option>
    <option value="Pertalite" {% if k.fuel_type == 'Pertalite' %}selected{% endif %}>Pertalite</option>
    <option value="Pertamax" {% if k.fuel_type == 'Pertamax' %}selected{% endif %}>Pertamax</option>
    <option value="Solar" {% if k.fuel_type == 'Solar' %}selected{% endif %}>Solar</option>
  </select>
</td>
</td>
                      <td>{{ k.mileage | round(2) }} m</td>
                      <td>{{ k.last_update }}</td>
                      <td>
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" role="switch"
                                 id="toggle-{{ k.imei }}"
                                 {% if k.status == 'Aktif' %}checked{% endif %}
                                 onchange="updateStatus('{{ k.imei }}', this.checked ? 'Aktif' : 'Tidak Aktif')">
                          <label class="form-check-label" for="toggle-{{ k.imei }}">
                            {{ 'Aktif' if k.status == 'Aktif' else 'Tidak Aktif' }}
                          </label>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

  </div>
</div>

<!-- JS Sidebar Toggle -->
<script src="{{ url_for('static', filename='js/sidebar-toggle.js') }}"></script>

<script>
  // Update status kendaraan (toggle aktif/tidak aktif)
  function updateStatus(imei, status) {
    fetch('/update_status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imei: imei, status: status })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const label = document.querySelector(`#toggle-${imei} + label`);
        if (label) label.innerText = status;
      } else {
        alert("Gagal update status");
      }
    })
    .catch(err => console.error("Error update status:", err));
  }

  // Update custom name kendaraan
  function updateName(imei, name) {
    fetch('/update_name', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imei: imei, custom_name: name })
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert("Gagal update nama");
      }
    })
    .catch(err => console.error("Error update nama:", err));
  }
</script>

<script>
  function setFuelColor(select) {
    const colors = {
      "Pertalite": "#28a745", // hijau
      "Pertamax": "#007bff",  // biru
      "Solar": "#dc3545",     // merah
      "None": "#6c757d"       // abu
    };
    select.style.backgroundColor = colors[select.value] || "#fff";
    select.style.color = (select.value === "None") ? "white" : "white";
  }

  function updateFuelType(imei, select) {
    let fuel_type = select.value;
    fetch('/update_fuel_type', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imei: imei, fuel_type: fuel_type })
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert("Gagal update jenis BBM");
      }
    })
    .catch(err => console.error("Error update fuel type:", err));

    setFuelColor(select); // update warna setelah pilih
  }

  // Set warna semua dropdown saat halaman selesai load
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".fuel-select").forEach(setFuelColor);
  });
</script>

</body>
</html>
